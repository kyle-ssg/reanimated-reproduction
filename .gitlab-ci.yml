stages:
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

.mobile_deploy_common_before_script: &mobile_deploy_common_before_script
  before_script:
    - echo fs.inotify.max_user_watches=524288 | tee -a /etc/sysctl.conf && sysctl -p # - used to increase file watchers limit on Linux
    - cd mobile
    - npm i

.mobile_deploy_common_required_changes: &mobile_deploy_common_required_changes
  changes:
    - common/**/*
    - mobile/**/*

.web_deploy_common_required_changes: &web_deploy_common_required_changes
  changes:
    - *
    - common/**/*
    - components/**/*
    - pages/**/*
    - project/**/*
    - static/**/*
    - styles/**/*

deploy-mobile-android-production:
    image: ssgluke/gitlab-ci-codepush:v1.5
    stage: deploy
    variables:
      ENV: prod
    <<: *mobile_deploy_common_before_script
    script:
        - ./../bin/distribute-mobile.sh $CODE_PUSH_APP_NAME_ANDROID Production master android
    only:
      <<: *mobile_deploy_common_required_changes
      refs:
        - master
      variables:
        - $APPCENTER_ACCESS_TOKEN
        - $CODE_PUSH_APP_NAME_ANDROID

deploy-mobile-android-staging:
    image: ssgluke/gitlab-ci-codepush:v1.5
    stage: deploy
    variables:
      ENV: staging
    <<: *mobile_deploy_common_before_script
    script:
        - ./../bin/distribute-mobile.sh $CODE_PUSH_APP_NAME_ANDROID Staging staging android
    only:
      <<: *mobile_deploy_common_required_changes
      refs:
        - staging
      variables:
        - $APPCENTER_ACCESS_TOKEN
        - $CODE_PUSH_APP_NAME_ANDROID

deploy-mobile-ios-production:
    image: ssgluke/gitlab-ci-codepush:v1.5
    stage: deploy
    variables:
      ENV: prod
    <<: *mobile_deploy_common_before_script
    script:
        - ./../bin/distribute-mobile.sh $CODE_PUSH_APP_NAME_IOS Production master ios
    only:
      <<: *mobile_deploy_common_required_changes
      refs:
        - master
      variables:
        - $APPCENTER_ACCESS_TOKEN
        - $CODE_PUSH_APP_NAME_IOS

deploy-mobile-ios-staging:
    image: ssgluke/gitlab-ci-codepush:v1.5
    stage: deploy
    variables:
      ENV: staging
    <<: *mobile_deploy_common_before_script
    script:
        - ./../bin/distribute-mobile.sh $CODE_PUSH_APP_NAME_IOS Staging staging ios
    only:
      <<: *mobile_deploy_common_required_changes
      refs:
        - staging
      variables:
        - $APPCENTER_ACCESS_TOKEN
        - $CODE_PUSH_APP_NAME_IOS

.web_deploy_common_script: &web_deploy_common_script
  before_script:
    - npm i -g now

deploy-web-production:
    image: mhart/alpine-node:10
    stage: deploy
    variables:
      ENV: prod
    <<: *web_deploy_common_script
    script:
        - now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json --prod --build-env ENV=$ENV --name=$CI_PROJECT_NAME
    only:
      refs:
        - master
      changes:
        <<: *web_deploy_common_required_changes
      variables:
        - $NOW_TOKEN
        - $NOW_TEAM_NAME

deploy-web-staging:
    image: mhart/alpine-node:10
    stage: deploy
    variables:
      ENV: staging
    <<: *web_deploy_common_script
    script:
        - url=$(now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json --build-env ENV=$ENV --name=$CI_PROJECT_NAME)
        - now alias --token $NOW_TOKEN --scope $NOW_TEAM_NAME $url ${CI_PROJECT_NAME}-staging
    only:
      refs:
        - staging
      changes:
        <<: *web_deploy_common_required_changes
      variables:
        - $NOW_TOKEN
        - $NOW_TEAM_NAME

deploy-web-develop:
    image: mhart/alpine-node:10
    stage: deploy
    variables:
      ENV: dev
    <<: *web_deploy_common_script
    script:
        - url=$(now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json --build-env ENV=$ENV --name=$CI_PROJECT_NAME)
        - now alias --token $NOW_TOKEN --scope $NOW_TEAM_NAME $url ${CI_PROJECT_NAME}-develop
    only:
      refs:
        - develop
      changes:
        <<: *web_deploy_common_required_changes
      variables:
        - $NOW_TOKEN
        - $NOW_TEAM_NAME

deploy-web-feature:
    image: mhart/alpine-node:10
    stage: deploy
    variables:
      ENV: dev
    <<: *web_deploy_common_script
    script:
        - now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json --build-env ENV=$ENV --name=$CI_PROJECT_NAME
    except:
      refs:
        - master
        - staging
        - develop
    only:
      changes:
        <<: *web_deploy_common_required_changes
      variables:
        - $NOW_TOKEN
        - $NOW_TEAM_NAME
