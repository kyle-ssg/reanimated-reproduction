stages:
  - setup_env
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

setup-env-production:
  stage: setup_env
  variables:
    ENV: prod
    CODE_PUSH_ENV: Production
  only:
    refs:
      - master

setup-env-staging:
  stage: setup_env
  variables:
    ENV: staging
    CODE_PUSH_ENV: Staging
  only:
    refs:
      - staging

setup-env-web-feature:
  stage: setup_env
  variables:
    ENV: dev
  except:
    refs:
      - master
      - staging

deploy-mobile:
    image: ssgluke/gitlab-ci-codepush:v1.5
    stage: deploy
    variables:
        CODE_PUSH_APP_NAME_ANDROID: Solid-State-Group/Frontend-Boilerplate-Android
        CODE_PUSH_APP_NAME_IOS: Solid-State-Group/Frontend-Boilerplate-iOS
    before_script:
        - appcenter login --token $APPCENTER_ACCESS_TOKEN
        - cd mobile
        - npm i
    script:
        # - // Use this Android alternative and tweak "awk 'NR == 2'" when overriding versionName via product flavors
        # - ANDROID_APP_VERSION=$(grep 'versionName' android/app/build.gradle | awk 'NR == 2' | grep -o '".*"' | tr -d '"')
        # - appcenter codepush release -a $CODE_PUSH_APP_NAME_ANDROID --target-binary-version $ANDROID_APP_VERSION -d $CODE_PUSH_ENV --disable-duplicate-release-error
        - appcenter codepush release -a $CODE_PUSH_APP_NAME_ANDROID -d $CODE_PUSH_ENV --disable-duplicate-release-error
        - appcenter codepush release -a $CODE_PUSH_APP_NAME_IOS -d $CODE_PUSH_ENV --disable-duplicate-release-error
    only:
      changes:
        - common/**
        - mobile/**
      refs:
        - master
        - staging

setup-env-web:
  stage: setup_env
  variables:
      NOW_TEAM_NAME: solidstategroup
  only:
      changes:
        - "{*, !(mobile)/**, !(bin)/**, !(cli)/**, !(tests)/**}"

deploy-web-production:
    image: mhart/alpine-node:10
    stage: deploy
    before_script:
        - npm i -g now
        - npm i --unsafe-perm
    script:
        - now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json --prod
    only:
      refs:
        - master
      changes:
        - "{*, !(mobile)/**, !(bin)/**, !(cli)/**, !(tests)/**}"

deploy-web-staging:
    image: mhart/alpine-node:10
    stage: deploy
    before_script:
        - npm i -g now
        - npm i --unsafe-perm
    script:
        - now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.staging.json --prod
    only:
      refs:
        - staging
      changes:
        - "{*, !(mobile)/**, !(bin)/**, !(cli)/**, !(tests)/**}"

deploy-web-feature:
    image: mhart/alpine-node:10
    stage: deploy
    before_script:
        - npm i -g now
        - npm i --unsafe-perm
    script:
        - now --token $NOW_TOKEN --scope $NOW_TEAM_NAME --confirm --local-config now.json
    except:
      refs:
        - master
        - staging
    only:
      changes:
        - "{*, !(mobile)/**, !(bin)/**, !(cli)/**, !(tests)/**}"
